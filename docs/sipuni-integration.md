# Sipuni Telephony Integration

This document describes the integration with Sipuni telephony service for automatic call record processing.

## Overview

The Sipuni integration allows the system to:
- Automatically fetch call records from Sipuni API
- Download call recordings
- Process recordings through STT (Speech-to-Text) service
- Analyze transcripts using LLM for quality scoring
- Store results in the database

## Environment Variables

Add the following environment variables to your `.env` file:

```env
# Sipuni API Configuration
SIPUNI_API_URL=https://sipuni.com/api
SIPUNI_API_KEY=your_sipuni_integration_key_here
SIPUNI_USER_ID=064629

# Example from your provided data:
# SIPUNI_API_KEY=0.tdtbjy193bm
```

## API Endpoints

### Unified Statistics Endpoint (Recommended)
```
GET /company/statistics?type=sipuni&dateFrom=2025-01-01&dateTo=2025-10-06
```
Get Sipuni statistics through the unified statistics endpoint. This integrates Sipuni data with other system statistics.

**Query Parameters:**
- `type`: `sipuni` | `all` | `overview` | `daily` | `monthly` | `dashboard`
- `dateFrom`: Start date (ISO format: YYYY-MM-DD)
- `dateTo`: End date (ISO format: YYYY-MM-DD)
- `extCode`: Employee extension code (optional)
- `employeeId`: Employee ID (optional)

**Example Response:**
```json
{
  "filters": {
    "type": "sipuni",
    "dateFrom": "2025-01-01T00:00:00.000Z",
    "dateTo": "2025-10-06T00:00:00.000Z"
  },
  "data": {
    "sipuni": {
      "sipuniData": {
        "totalRecords": 150,
        "totalDuration": 45000,
        "recordsWithAudio": 120,
        "processedInSystem": 100,
        "processingRate": 83
      },
      "recentRecords": [...],
      "period": {
        "from": "01.01.2025",
        "to": "06.10.2025"
      },
      "lastSync": "2025-10-06T11:48:00.000Z"
    }
  }
}
```

### Direct Sipuni Endpoints

### 1. Export Statistics
```
POST /sipuni/export-statistics
```
Export call statistics from Sipuni API in CSV format.

**Request Body:**
```json
{
  "user": "064629",
  "from": "01.01.2025",
  "to": "06.10.2025",
  "type": "0",
  "state": "0"
}
```

### 2. Fetch Call Records
```
GET /sipuni/fetch-records?from=01.01.2025&to=06.10.2025
```
Fetch call records from Sipuni API without processing.

### 3. Sync Records
```
POST /sipuni/sync-records?from=01.01.2025&to=06.10.2025
```
Download and process call records from Sipuni (full workflow).

### 4. Manual Sync
```
POST /sipuni/manual-sync?from=01.01.2025&to=06.10.2025
```
Manual sync for specific date range with detailed response.

### 5. Test Connection
```
GET /sipuni/test-connection
```
Test Sipuni API connection.

### 6. Download CSV File (PHP Style)
```
GET /sipuni/download-csv?from=01.01.2025&to=06.10.2025&user=064629
```
Download CSV file directly (like PHP version with headers).

### 7. Download CSV as JSON
```
GET /sipuni/download-csv-json?from=01.01.2025&to=06.10.2025&user=064629
```
Get CSV data as JSON response for API consumption.

## Automatic Processing

### Daily Scheduled Job
The system automatically runs a daily job at midnight to:
1. Fetch previous day's call records from Sipuni
2. Download recordings to `./recordings` directory
3. Process each recording through STT service
4. Analyze transcripts using LLM
5. Store results in database
6. Clean up audio files after processing

### Processing Workflow
1. **Fetch Records**: Get call data from Sipuni API
2. **Employee Matching**: Match phone numbers to employees in database
3. **Download Recording**: Download audio file from Sipuni
4. **Create Call Record**: Store call metadata in database
5. **STT Processing**: Convert audio to text using AI service
6. **LLM Analysis**: Analyze transcript for quality scoring
7. **Store Results**: Save scores, violations, and analysis
8. **Cleanup**: Remove audio files to save storage

## Configuration Parameters

The Sipuni API uses the following parameters (with defaults):

| Parameter | Default | Description |
|-----------|---------|-------------|
| user | SIPUNI_USER_ID | User ID for API access |
| from | today | Start date (dd.mm.yyyy) |
| to | today | End date (dd.mm.yyyy) |
| type | "0" | Call type filter |
| state | "0" | Call state filter |
| timeFrom | "10:00" | Start time filter |
| timeTo | "20:00" | End time filter |
| anonymous | "1" | Include anonymous calls |
| rating | "5" | Rating filter |
| outgoingLine | "1" | Outgoing line filter |

## Hash Generation

The API requires MD5 hash authentication. The hash is generated by:
1. Sorting all parameters alphabetically
2. Joining values with '+' separator
3. Appending the API key
4. Creating MD5 hash of the resulting string

## Error Handling

The service includes comprehensive error handling:
- API connection timeouts and retries
- Invalid date formats
- Missing employee records
- File download failures
- STT service errors
- Database transaction failures

## Monitoring

Check logs for:
- `[SIPUNI]` - General Sipuni service operations
- `[EXPORT]` - Statistics export operations
- `[FETCH]` - Call record fetching
- `[PROCESS]` - Call processing workflow
- `[RECORD]` - Individual record processing
- `[DOWNLOAD]` - File download operations
- `[CRON]` - Scheduled job execution
- `[MANUAL]` - Manual sync operations

## Usage Examples

### Manual Sync for Date Range
```bash
curl -X POST "http://localhost:3000/sipuni/manual-sync?from=01.01.2025&to=31.01.2025"
```

### Test API Connection
```bash
curl -X GET "http://localhost:3000/sipuni/test-connection"
```

### Export Statistics
```bash
curl -X POST "http://localhost:3000/sipuni/export-statistics" \
  -H "Content-Type: application/json" \
  -d '{
    "user": "064629",
    "from": "01.01.2025",
    "to": "31.01.2025"
  }'
```

## Integration with Existing System

The Sipuni service integrates seamlessly with the existing call processing system:
- Uses the same `AiService` for STT and LLM processing
- Stores data in the same database schema
- Follows the same call status workflow (UPLOADED → PROCESSING → DONE)
- Maintains compatibility with existing analytics and reporting

## Troubleshooting

### Common Issues

1. **API Authentication Errors**
   - Verify `SIPUNI_API_KEY` is correct
   - Check `SIPUNI_USER_ID` matches your account

2. **No Call Records Found**
   - Verify date format (dd.mm.yyyy)
   - Check if calls exist for the specified date range
   - Ensure calls have recording URLs

3. **Employee Not Found**
   - Verify employee phone numbers in database
   - Check phone number format consistency

4. **Download Failures**
   - Check network connectivity
   - Verify recording URLs are accessible
   - Check disk space for recordings directory

5. **Processing Errors**
   - Verify STT service is configured and accessible
   - Check LLM API credentials
   - Monitor database connection
